import os as os
import os.path
from csv import writer
import math
import numpy as np
from joblib import Parallel, delayed
import multiprocessing
import subprocess
    
# Extract pe features
def getPeFeatures(malwareDirectory,peOutput):
    print("Getting pe features...")
    
    tfiles = os.listdir(malwareDirectory)
    numberOfPeFiles = len(tfiles)
    print("Number of pe files: ", numberOfPeFiles)

    defaultCores=16
    cores = defaultCores

    if numberOfPeFiles<cores:
        loopCuts=1
        cores=numberOfPeFiles
    else:
        loopCuts = int(math.ceil(numberOfPeFiles/cores))

    countLoopProcessed = 0
    sumToRank=0
    for i in range(loopCuts):
        print("Loop: ", countLoopProcessed)
        if numberOfPeFiles<cores:
            cores=numberOfPeFiles
        if i>0:
            sumToRank+=defaultCores
        
        fout = str(peOutput)+str(i)+".txt"
        params = [str(cores),str(sumToRank),malwareDirectory,peOutput,fout]
        args = ['qsub','pe.sub'] + params
        output = subprocess.Popen(args,stdout=subprocess.PIPE).stdout.read()
        print("Output: ",output)
        countLoopProcessed+=1
        numberOfPeFiles+=1
    
